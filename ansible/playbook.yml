---

- hosts: all

  vars:

    #image:             manala_app
    #image_description: Foo bar
    #image_version:     x.x.x

    #app_env:   dev|test
    #app_user:  app
    #app_group: app
    #app_dir:   /srv/app

    app_log_dir:      "{{ manala_skeleton_options.app_log_dir }}"
    app_cache_dir:    "{{ manala_skeleton_options.app_cache_dir }}"
    app_sessions_dir: "{{ manala_skeleton_options.app_sessions_dir }}"

    #################
    # Manala - Sudo #
    #################

    manala_sudo_sudoers_exclusive: true
    manala_sudo_sudoers:
      - file: "{{ app_user }}"
        config:
          - app: ALL=NOPASSWD:ALL

    ##################
    # Manala - Users #
    ##################

    manala_users_groups:
      - "{{ app_group }}"

    manala_users:
      - name:     root
        password: $1$hVMBHhKk$4zC4YK.KRk3Vy9fmLd7681 # Null password generated by "mkpasswd -s -m md5"
      - name:     "{{ app_user }}"
        password: $1$hVMBHhKk$4zC4YK.KRk3Vy9fmLd7681 # Null password generated by "mkpasswd -s -m md5"
        group:    "{{ app_group }}"
        groups:   ['sudo']
        authorized_keys:
          - "{{ lookup('url', 'https://raw.githubusercontent.com/mitchellh/vagrant/master/keys/vagrant.pub') }}"

    ####################
    # Manala - Locales #
    ####################

    manala_locales:
      - name:  en_US.UTF-8
        state: absent

    manala_locales_default: C.UTF-8

    #####################
    # Manala - Skeleton #
    #####################

    manala_skeleton:     "{{ image }}"
    manala_skeleton_env: "{{ app_env }}"
    manala_skeleton_patterns_hashes:
      - skeleton_patterns

    ############
    # Skeleton #
    ############

    skeleton_patterns:
      motd: "{{ image_description }} - {{ image_version }}"

    ###########################
    # Manala - Ansible Galaxy #
    ###########################

    manala_ansible_galaxy_roles:
      - manala.ansible-galaxy
      - manala.apt
      - manala.skeleton
      - manala.deploy

  roles:
    - role: manala.sudo
    - role: manala.users
    - role: manala.locales
    - role: manala.skeleton
    - role: manala.ansible-galaxy
