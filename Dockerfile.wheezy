FROM debian:wheezy

MAINTAINER Manala <contact@manala.io>

# Image
ARG IMAGE
ARG IMAGE_DESCRIPTION
ARG IMAGE_VERSION

# Env
ARG ENV

WORKDIR /tmp

COPY scripts scripts

RUN bash scripts/apt.sh \
    && bash scripts/ansible.sh

COPY ansible ansible

RUN ansible-playbook ansible/setup.yml

USER app

RUN ansible-playbook \
        --extra-vars "\
image='$IMAGE' \
image_description='$IMAGE_DESCRIPTION' \
image_version='$IMAGE_VERSION'" \
        ansible/app.yml

RUN sudo bash scripts/clean.sh

WORKDIR /srv/app
